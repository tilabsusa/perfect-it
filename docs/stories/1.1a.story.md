# Story 1.1a: Testing Infrastructure Setup

## Status
Draft

## Story
**As a** developer,  
**I want** comprehensive testing infrastructure with Jest, MSW, and Playwright configured,  
**So that** we can ensure code quality and reliability from day one with proper mocking and testing patterns.

## Acceptance Criteria
1. MSW (Mock Service Worker) installed and configured for API mocking in tests
2. Jest configuration enhanced with coverage thresholds and reporters
3. Test data factories created for common data models
4. Example test files created demonstrating testing patterns for components, hooks, and utilities
5. Playwright configuration enhanced with test fixtures and page objects
6. CI-friendly test scripts configured with proper exit codes and reporting
7. Test utilities and custom matchers configured for Amplify-specific testing
8. Coverage reports configured to generate in multiple formats (text, lcov, html)

## Tasks / Subtasks
- [ ] **Task 1: Install and Configure MSW** (AC: 1)
  - [ ] Install MSW: `npm install --save-dev msw@2.1.0`
  - [ ] Create `mocks/handlers.ts` for GraphQL and REST API mock handlers
  - [ ] Create `mocks/server.ts` for Node.js test environment setup
  - [ ] Create `mocks/browser.ts` for browser environment setup (development)
  - [ ] Add MSW initialization to `jest.setup.js`
  - [ ] Create example GraphQL mock handlers for User and PerfectionCard queries

- [ ] **Task 2: Enhance Jest Configuration** (AC: 2, 8)
  - [ ] Update `jest.config.js` with coverage thresholds: Components 80%, Utilities 95%, Hooks 90%, Lambda 85%
  - [ ] Configure coverage reporters: text, text-summary, lcov, html
  - [ ] Set up coverage collection from proper source directories
  - [ ] Configure module name mapper for path aliases (@/components, @/lib, etc.)
  - [ ] Add test environment variables configuration
  - [ ] Configure transform ignore patterns for Amplify modules

- [ ] **Task 3: Create Test Data Factories** (AC: 3)
  - [ ] Create `tests/factories/` directory structure
  - [ ] Implement `tests/factories/user.factory.ts` with User model factory
  - [ ] Implement `tests/factories/perfectionCard.factory.ts` with PerfectionCard factory
  - [ ] Implement `tests/factories/auth.factory.ts` with authentication token factories
  - [ ] Create `tests/factories/index.ts` to export all factories
  - [ ] Use faker.js or similar for realistic test data generation

- [ ] **Task 4: Create Example Test Files** (AC: 4)
  - [ ] Create `components/ui/Navigation.test.tsx` demonstrating component testing with RTL
  - [ ] Create `hooks/useAuth.test.ts` demonstrating hook testing with renderHook
  - [ ] Create `lib/utils/validation.test.ts` demonstrating utility function testing
  - [ ] Create `app/(auth)/login/page.test.tsx` demonstrating page component testing
  - [ ] Add comments explaining testing patterns and best practices in each file

- [ ] **Task 5: Enhance Playwright Configuration** (AC: 5)
  - [ ] Create `tests/e2e/fixtures/` directory for test fixtures
  - [ ] Implement `tests/e2e/fixtures/auth.fixture.ts` for authentication setup
  - [ ] Create `tests/e2e/pages/` directory for page objects
  - [ ] Implement `tests/e2e/pages/LoginPage.ts` as example page object pattern
  - [ ] Update `playwright.config.ts` with projects for different browsers and viewports
  - [ ] Configure screenshot and video capture on failure

- [ ] **Task 6: Configure CI-Friendly Test Scripts** (AC: 6)
  - [ ] Update package.json scripts: `test:ci` for CI environment
  - [ ] Add `test:coverage` script with minimum threshold enforcement
  - [ ] Add `test:watch` script for development
  - [ ] Configure `test:integration` script using MSW
  - [ ] Add `test:e2e:headless` script for CI E2E tests
  - [ ] Ensure all test scripts return proper exit codes for CI/CD

- [ ] **Task 7: Create Amplify Test Utilities** (AC: 7)
  - [ ] Create `tests/utils/amplify.ts` with Amplify client mock setup
  - [ ] Implement custom matchers for GraphQL responses in `tests/utils/matchers.ts`
  - [ ] Create `tests/utils/auth.ts` with authentication test helpers
  - [ ] Create `tests/utils/render.tsx` with custom render function wrapping providers
  - [ ] Document usage patterns for each utility

- [ ] **Task 8: Set Up Coverage Integration** (AC: 8)
  - [ ] Configure `.gitignore` to exclude coverage directories
  - [ ] Create `tests/coverage.md` documenting coverage requirements and how to view reports
  - [ ] Set up pre-commit hook to run tests on changed files
  - [ ] Configure coverage badge generation for README
  - [ ] Test coverage report generation in all formats

## Dev Notes

### Previous Story Insights
- Story 1.1 established basic Jest (29.7.0) and Playwright (1.41.0) installation
- Test directory structure was created (tests/unit/, tests/e2e/)
- Basic test scripts were added to package.json (test, test:unit, test:e2e)
- jest.config.js and jest.setup.js files were created with minimal configuration
- This story (1.1a) enhances and completes the testing infrastructure

### MSW (Mock Service Worker) Configuration
MSW enables API mocking for both development and testing:
```typescript
// Version: 2.1.0
// Documentation: https://mswjs.io/docs/

// Use in tests: Intercept requests in Node.js environment
// Use in development: Intercept requests in browser for offline development
```

Mock handlers location: `mocks/handlers.ts`
Server setup: `mocks/server.ts` (for Jest)
Browser setup: `mocks/browser.ts` (for development)

[Source: architecture/testing-strategy.md#Integration Testing]

### Coverage Requirements
Based on architecture specifications:
- **Components**: 80% coverage
- **Utilities**: 95% coverage  
- **Hooks**: 90% coverage
- **Lambda functions**: 85% coverage

These thresholds should be enforced in jest.config.js:
```javascript
coverageThreshold: {
  global: {
    branches: 75,
    functions: 80,
    lines: 80,
    statements: 80
  },
  './components/**/*.{ts,tsx}': {
    branches: 75,
    functions: 80,
    lines: 80,
    statements: 80
  },
  './lib/utils/**/*.ts': {
    branches: 90,
    functions: 95,
    lines: 95,
    statements: 95
  },
  './hooks/**/*.ts': {
    branches: 85,
    functions: 90,
    lines: 90,
    statements: 90
  }
}
```
[Source: architecture/testing-strategy.md#Unit Testing]

### Testing Pyramid Distribution
The architecture specifies:
- 80% Unit tests (components, functions, hooks)
- 15% Integration tests (API, service integration)
- 5% E2E tests (critical user journeys)

[Source: architecture/testing-strategy.md#Testing Pyramid]

### Test File Locations
- **Unit tests**: Colocated with source files or in `__tests__` directories
- **Integration tests**: `tests/integration/` directory
- **E2E tests**: `tests/e2e/` directory (already created in Story 1.1)
- **Test utilities**: `tests/utils/` directory
- **Test factories**: `tests/factories/` directory
- **MSW mocks**: `mocks/` directory at project root

Example test file locations:
```
components/cards/CardGrid.test.tsx
hooks/useAuth.test.ts
amplify/functions/image-processor/handler.test.ts
lib/utils/validation.test.ts
```
[Source: architecture/testing-strategy.md#Unit Testing]

### Critical E2E Test Paths
The following user journeys must have E2E tests:
1. User registration and login
2. Create and publish Perfection Card
3. Search and filter cards
4. Vote and comment interactions

[Source: architecture/testing-strategy.md#End-to-End Testing]

### Technology Versions
- **Jest**: 29.7.0 (already installed)
- **Playwright**: 1.41.2 (note: 1.41.0 was installed, may need update)
- **MSW**: 2.1.0 (to be installed)
- **React Testing Library**: Already installed in Story 1.1
- **@testing-library/jest-dom**: Already installed in Story 1.1

[Source: architecture/tech-stack.md]

### Environment-Specific Testing
- **Local**: Test against sandbox backend with mock data
- **Staging**: Pre-production validation with test data
- **Production**: Smoke tests only

[Source: architecture/testing-strategy.md#End-to-End Testing]

### Testing

**Testing Standards to Follow:**
- **Test File Naming**: Use `.test.ts` or `.test.tsx` suffix
- **Test Organization**: Use describe blocks for grouping related tests
- **Test Naming**: Use clear, descriptive test names that explain what is being tested
- **Assertions**: Use jest-dom matchers for better error messages
- **Async Testing**: Properly handle async operations with async/await or waitFor
- **Cleanup**: Ensure proper cleanup in afterEach blocks
- **Mocking**: Use MSW for API mocking, jest.mock for module mocking

**Coverage Reporting:**
- Generate coverage reports in: text (console), lcov (CI integration), html (local viewing)
- Coverage reports output to: `coverage/` directory
- View HTML report: `open coverage/index.html`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results